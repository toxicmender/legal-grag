name: CI

on: [push, pull_request]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version-file: ".python-version"
      - uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: uv.lock
      - run: uv sync --locked --dev
      - run: uv run ruff check .

  unit-tests:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version-file: ".python-version"
      - uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: uv.lock
      - run: uv sync --locked --all-extras --dev
      - name: Run unit tests
        run: |
          uv run pytest tests \
            -m unit \
            -n auto \
            --cov=src \
            --cov-report=xml \
            --cov-report=term

      - uses: actions/upload-artifact@v4
        with:
          name: coverage-data
          path: |
            coverage.xml
            .coverage

  integration-tests:
    runs-on: ubuntu-latest
    needs: unit-tests

    services:
      neo4j:
        image: neo4j:5
        ports:
          - "7687:7687"
        env:
          NEO4J_AUTH: neo4j/${{ secrets.NEO4J_PASSWORD }}
        options: >-
          --health-cmd="cypher-shell -u neo4j -p ${{ secrets.NEO4J_PASSWORD }} 'RETURN 1'"
          --health-interval=10s
          --health-retries=10

    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version-file: ".python-version"
      - uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: uv.lock
      - run: uv sync --locked --all-extras --dev
      - name: Run integration tests
        run: |
          uv run pytest tests \
            -m integration \
            -n auto
        env:
          NEO4J_URI: bolt://localhost:7687
          NEO4J_USER: neo4j
          NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}

  coverage:
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]

    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version-file: ".python-version"
      - uses: astral-sh/setup-uv@v7
      - run: uv sync --locked --dev

      - uses: actions/download-artifact@v7
        with:
          name: coverage-data

      - name: Enforce per-module coverage
        run: |
          uv run coverage report --include="src/kg_build/*" --fail-under=90
          uv run coverage report --include="src/nlp/*" --fail-under=80
          uv run coverage report --include="src/reason/*" --fail-under=85

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: coverage.xml
          fail_ci_if_error: true
